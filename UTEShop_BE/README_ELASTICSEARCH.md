# üîç H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG ELASTICSEARCH

## üìã **C√°c b∆∞·ªõc c√†i ƒë·∫∑t**

### 1Ô∏è‚É£ **Kh·ªüi ƒë·ªông Elasticsearch v·ªõi Docker**

```bash
# T·ª´ th∆∞ m·ª•c g·ªëc project (c√≥ file docker-compose.yml)
docker-compose up -d

# Ki·ªÉm tra container ƒëang ch·∫°y
docker-compose ps

# Ki·ªÉm tra logs
docker-compose logs -f elasticsearch
```

### 2Ô∏è‚É£ **C·∫•u h√¨nh m√¥i tr∆∞·ªùng**

T·∫°o file `.env` trong `UTEShop_BE` (copy t·ª´ `.env.example`):

```env
# Elasticsearch Configuration
ELASTICSEARCH_NODE=http://localhost:9200
ELASTICSEARCH_INDEX_PRODUCTS=uteshop_products
```

### 3Ô∏è‚É£ **ƒê·ªìng b·ªô d·ªØ li·ªáu**

```bash
cd UTEShop_BE
npm run sync:elasticsearch
```

Script n√†y s·∫Ω:
- ‚úÖ T·∫°o index `uteshop_products` n·∫øu ch∆∞a c√≥
- ‚úÖ ƒê·ªìng b·ªô t·∫•t c·∫£ s·∫£n ph·∫©m t·ª´ MongoDB v√†o Elasticsearch
- ‚úÖ Thi·∫øt l·∫≠p mapping t·ªëi ∆∞u cho t√¨m ki·∫øm ti·∫øng Vi·ªát

---

## üåê **API Endpoints**

### üîç **1. T√¨m ki·∫øm s·∫£n ph·∫©m**

```http
GET /api/elasticsearch/search
```

**Query Parameters:**
- `q` - T·ª´ kh√≥a t√¨m ki·∫øm (VD: "√°o s∆° mi", "giay nike")
- `category` - L·ªçc theo danh m·ª•c
- `brand` - L·ªçc theo th∆∞∆°ng hi·ªáu
- `minPrice` - Gi√° t·ªëi thi·ªÉu
- `maxPrice` - Gi√° t·ªëi ƒëa
- `page` - Trang hi·ªán t·∫°i (default: 1)
- `limit` - S·ªë s·∫£n ph·∫©m/trang (default: 12)
- `sort` - S·∫Øp x·∫øp:
  - `relevance` (m·∫∑c ƒë·ªãnh) - Theo ƒë·ªô li√™n quan
  - `price-asc` - Gi√° tƒÉng d·∫ßn
  - `price-desc` - Gi√° gi·∫£m d·∫ßn
  - `newest` - M·ªõi nh·∫•t
  - `best-selling` - B√°n ch·∫°y nh·∫•t
  - `top-rated` - ƒê√°nh gi√° cao nh·∫•t

**V√≠ d·ª•:**

```bash
# T√¨m "√°o", l·ªçc danh m·ª•c "√Åo", gi√° 100k-500k
curl "http://localhost:5000/api/elasticsearch/search?q=√°o&category=√Åo&minPrice=100000&maxPrice=500000"

# T√¨m "gi√†y nike", s·∫Øp x·∫øp theo gi√° tƒÉng d·∫ßn
curl "http://localhost:5000/api/elasticsearch/search?q=gi√†y nike&brand=Nike&sort=price-asc"

# L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m, s·∫Øp x·∫øp theo b√°n ch·∫°y
curl "http://localhost:5000/api/elasticsearch/search?sort=best-selling"
```

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "_id": "673...",
      "name": "√Åo s∆° mi nam",
      "price": 299000,
      "discountedPrice": 239200,
      "discountPercentage": 20,
      "images": ["url1", "url2"],
      "category": {
        "_id": "672...",
        "name": "√Åo"
      },
      "brand": {
        "_id": "671...",
        "name": "Zara"
      },
      "_score": 1.234
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 12,
    "total": 45,
    "totalPages": 4
  },
  "facets": {
    "categories": [
      { "key": "√Åo", "doc_count": 25 },
      { "key": "Qu·∫ßn", "doc_count": 20 }
    ],
    "brands": [
      { "key": "Nike", "doc_count": 15 },
      { "key": "Adidas", "doc_count": 10 }
    ],
    "priceRanges": [
      { "key": "under-500k", "doc_count": 12 },
      { "key": "500k-1m", "doc_count": 18 }
    ],
    "priceStats": {
      "min": 100000,
      "max": 5000000,
      "avg": 750000
    }
  }
}
```

---

### üí° **2. G·ª£i √Ω t√¨m ki·∫øm (Autocomplete)**

```http
GET /api/elasticsearch/suggest
```

**Query Parameters:**
- `q` - T·ª´ kh√≥a (t·ªëi thi·ªÉu 2 k√Ω t·ª±)
- `limit` - S·ªë g·ª£i √Ω (default: 5)

**V√≠ d·ª•:**

```bash
curl "http://localhost:5000/api/elasticsearch/suggest?q=√°o&limit=5"
```

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "_id": "673...",
      "name": "√Åo s∆° mi nam",
      "price": 299000,
      "discountedPrice": 239200,
      "images": ["url1"]
    }
  ]
}
```

---

### üìä **3. L·∫•y facets (b·ªô l·ªçc)**

```http
GET /api/elasticsearch/facets
```

Tr·∫£ v·ªÅ th·ªëng k√™ v·ªÅ categories, brands, price ranges.

**Response:**

```json
{
  "success": true,
  "data": {
    "categories": [
      { "key": "√Åo", "doc_count": 25 },
      { "key": "Qu·∫ßn", "doc_count": 20 }
    ],
    "brands": [
      { "key": "Nike", "doc_count": 15 }
    ],
    "priceRanges": [...],
    "priceStats": {
      "min": 100000,
      "max": 5000000,
      "avg": 750000
    }
  }
}
```

---

### ‚ù§Ô∏è **4. Health Check**

```http
GET /api/elasticsearch/health
```

Ki·ªÉm tra Elasticsearch c√≥ ƒëang ch·∫°y kh√¥ng.

**Response:**

```json
{
  "success": true,
  "message": "Elasticsearch ƒëang ho·∫°t ƒë·ªông"
}
```

---

### üîß **5. Admin: ƒê·ªìng b·ªô m·ªôt s·∫£n ph·∫©m**

```http
POST /api/elasticsearch/sync/:productId
```

ƒê·ªìng b·ªô m·ªôt s·∫£n ph·∫©m c·ª• th·ªÉ v√†o Elasticsearch (sau khi t·∫°o/s·ª≠a).

---

### üóëÔ∏è **6. Admin: X√≥a s·∫£n ph·∫©m kh·ªèi Elasticsearch**

```http
DELETE /api/elasticsearch/delete/:productId
```

X√≥a m·ªôt s·∫£n ph·∫©m kh·ªèi Elasticsearch (sau khi x√≥a kh·ªèi MongoDB).

---

## üé® **T√≠ch h·ª£p v√†o Frontend**

### **V√≠ d·ª•: T√¨m ki·∫øm v·ªõi React**

```javascript
import { useState, useEffect } from 'react';
import axios from 'axios';

function SearchProducts() {
  const [query, setQuery] = useState('');
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [facets, setFacets] = useState(null);

  const searchProducts = async () => {
    try {
      setLoading(true);
      const { data } = await axios.get('/api/elasticsearch/search', {
        params: {
          q: query,
          page: 1,
          limit: 12,
          sort: 'relevance'
        }
      });
      setProducts(data.data);
      setFacets(data.facets);
    } catch (error) {
      console.error('Search error:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    const timer = setTimeout(() => {
      if (query.length >= 2) {
        searchProducts();
      }
    }, 300); // Debounce 300ms

    return () => clearTimeout(timer);
  }, [query]);

  return (
    <div>
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
      />
      
      {loading && <p>ƒêang t√¨m ki·∫øm...</p>}
      
      {/* Facets */}
      {facets && (
        <div>
          <h3>Danh m·ª•c:</h3>
          {facets.categories.map(cat => (
            <button key={cat.key}>
              {cat.key} ({cat.doc_count})
            </button>
          ))}
        </div>
      )}
      
      {/* Products */}
      <div>
        {products.map(product => (
          <div key={product._id}>
            <h4>{product.name}</h4>
            <p>{product.discountedPrice.toLocaleString()}ƒë</p>
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

### **V√≠ d·ª•: Autocomplete v·ªõi React**

```javascript
import { useState, useEffect } from 'react';
import axios from 'axios';

function SearchAutocomplete() {
  const [query, setQuery] = useState('');
  const [suggestions, setSuggestions] = useState([]);

  useEffect(() => {
    const fetchSuggestions = async () => {
      if (query.length < 2) {
        setSuggestions([]);
        return;
      }

      try {
        const { data } = await axios.get('/api/elasticsearch/suggest', {
          params: { q: query, limit: 5 }
        });
        setSuggestions(data.data);
      } catch (error) {
        console.error('Suggest error:', error);
      }
    };

    const timer = setTimeout(fetchSuggestions, 200);
    return () => clearTimeout(timer);
  }, [query]);

  return (
    <div className="search-autocomplete">
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="T√¨m ki·∫øm..."
      />
      
      {suggestions.length > 0 && (
        <div className="suggestions">
          {suggestions.map(item => (
            <div key={item._id} className="suggestion-item">
              <img src={item.images[0]} alt={item.name} />
              <span>{item.name}</span>
              <span>{item.discountedPrice.toLocaleString()}ƒë</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

---

## üîÑ **Auto-sync khi CRUD s·∫£n ph·∫©m**

ƒê·ªÉ t·ª± ƒë·ªông ƒë·ªìng b·ªô khi t·∫°o/s·ª≠a/x√≥a s·∫£n ph·∫©m, th√™m code sau v√†o controller:

```javascript
import elasticsearchService from '../services/elasticsearchService.js';

// Trong createProduct
const newProduct = await Product.create(productData);
await elasticsearchService.indexProduct(newProduct);

// Trong updateProduct
const updated = await Product.findByIdAndUpdate(id, data, { new: true })
  .populate('category', 'name')
  .populate('brand', 'name');
await elasticsearchService.indexProduct(updated);

// Trong deleteProduct
await Product.findByIdAndDelete(id);
await elasticsearchService.deleteProduct(id);
```

---

## üöÄ **T√≠nh nƒÉng n·ªïi b·∫≠t**

‚úÖ **Full-text search** - T√¨m ki·∫øm to√†n vƒÉn trong t√™n v√† m√¥ t·∫£  
‚úÖ **Fuzzy matching** - Ch·ªãu l·ªói ch√≠nh t·∫£ (VD: "a√≥" ‚Üí "√°o")  
‚úÖ **Vietnamese support** - H·ªó tr·ª£ ti·∫øng Vi·ªát c√≥ d·∫•u  
‚úÖ **Multi-field search** - T√¨m trong nhi·ªÅu tr∆∞·ªùng (name, description)  
‚úÖ **Faceted search** - L·ªçc theo category, brand, price range  
‚úÖ **Flexible sorting** - S·∫Øp x·∫øp linh ho·∫°t (relevance, price, date, rating)  
‚úÖ **Autocomplete** - G·ª£i √Ω t√¨m ki·∫øm theo t·ª´ kh√≥a  
‚úÖ **Aggregations** - Th·ªëng k√™ facets v√† price range  
‚úÖ **Performance** - C·ª±c nhanh, c√≥ th·ªÉ x·ª≠ l√Ω h√†ng tri·ªáu s·∫£n ph·∫©m  

---

## üõ†Ô∏è **Troubleshooting**

### **L·ªói: Connection refused**

```bash
# Ki·ªÉm tra Elasticsearch ƒëang ch·∫°y
curl http://localhost:9200

# Kh·ªüi ƒë·ªông l·∫°i
docker-compose restart elasticsearch
```

### **L·ªói: Index not found**

```bash
# Ch·∫°y l·∫°i sync
cd UTEShop_BE
npm run sync:elasticsearch
```

### **T√¨m ki·∫øm kh√¥ng ra k·∫øt qu·∫£**

```bash
# Ki·ªÉm tra s·ªë documents trong index
curl http://localhost:9200/uteshop_products/_count

# Xem mapping
curl http://localhost:9200/uteshop_products/_mapping?pretty
```

---

## üìö **T√†i li·ªáu tham kh·∫£o**

- [Elasticsearch Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- [Elasticsearch Node.js Client](https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/index.html)
- [Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)

---

**üéâ ELASTICSEARCH ƒê√É S·∫¥NG S√ÄNG! T√åM KI·∫æM C·ª∞C NHANH!** üöÄ

