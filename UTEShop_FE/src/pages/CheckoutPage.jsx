import React, { useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate, useLocation } from 'react-router-dom';
import { createOrder } from '../features/order/orderSlice';
import { updateUserProfile } from '../features/auth/authSlice';
import { Button } from '../components/ui/button';
import { Card } from '../components/ui/card';
import PaymentMethod from '../components/PaymentMethod';
import MoMoPaymentForm from '../components/MoMoPaymentForm';
import api from '../api/axiosConfig';

const CheckoutPage = () => {
    const dispatch = useDispatch();
    const navigate = useNavigate();
    const location = useLocation();
    const { user } = useSelector((state) => state.auth);

    // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ state c·ªßa navigation
    const [productDetails, setProductDetails] = useState(null);
    const [cartItems, setCartItems] = useState([]);
    const [quantity, setQuantity] = useState(1);
    const [customerName, setCustomerName] = useState('');
    const [shippingAddress, setShippingAddress] = useState('');
    const [phoneNumber, setPhoneNumber] = useState('');
    const [phoneError, setPhoneError] = useState('');
    const [paymentMethod, setPaymentMethod] = useState('MOMO');
    const [isProcessingPayment, setIsProcessingPayment] = useState(false);
    const [paymentError, setPaymentError] = useState('');
    const [isInitialized, setIsInitialized] = useState(false);
    const [isFromCart, setIsFromCart] = useState(false);

    // Fetch th√¥ng tin user m·ªõi nh·∫•t t·ª´ API
    useEffect(() => {
        const fetchUserProfile = async () => {
            if (user) {
                try {
                    const response = await api.get('/user/profile');
                    // C·∫≠p nh·∫≠t Redux store v·ªõi th√¥ng tin m·ªõi nh·∫•t
                    dispatch(updateUserProfile(response.data));
                } catch (error) {
                    console.error('L·ªói khi fetch th√¥ng tin user:', error);
                }
            }
        };

        fetchUserProfile();
    }, [dispatch, user]);

    // useEffect ƒë·ªÉ x·ª≠ l√Ω URL v√† navigation
    useEffect(() => {
        // X√≥a URL parameters n·∫øu c√≥ (ƒë·ªÉ tr√°nh x·ª≠ l√Ω callback ·ªü ƒë√¢y)
        const urlParams = new URLSearchParams(window.location.search);
        console.log('üîç CheckoutPage - Current URL params:', Object.fromEntries(urlParams));

        if (urlParams.get('partnerCode') === 'MOMO') {
            console.log('üéØ CheckoutPage - Detected MoMo callback, redirecting to PaymentSuccessPage');
            // Redirect ƒë·∫øn PaymentSuccessPage n·∫øu c√≥ callback t·ª´ MoMo
            const currentUrl = new URL(window.location);
            const successUrl = `/payment/success${currentUrl.search}`;
            console.log('üöÄ CheckoutPage - Redirecting to:', successUrl);
            window.history.replaceState({}, document.title, window.location.pathname);
            navigate(successUrl);
            return;
        }

        // Ki·ªÉm tra xem c√≥ th√¥ng tin s·∫£n ph·∫©m ƒë∆∞·ª£c truy·ªÅn kh√¥ng
        const state = location.state;
        if (!state || (!state.product && !state.cartItems)) {
            // N·∫øu kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m, chuy·ªÉn v·ªÅ trang s·∫£n ph·∫©m
            navigate('/products', {
                state: {
                    error: 'Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n'
                }
            });
            return;
        }

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!user) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n');
            navigate('/login');
            return;
        }

        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p mua t·ª´ gi·ªè h√†ng
        if (state.cartItems && state.fromCart) {
            setCartItems(state.cartItems);
            setIsFromCart(true);
        } else if (state.product) {
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p mua tr·ª±c ti·∫øp
            setProductDetails(state.product);
            setQuantity(state.quantity || 1);
            setIsFromCart(false);
        }
    }, [location, user, navigate, dispatch]);

    // useEffect ri√™ng ƒë·ªÉ ƒëi·ªÅn th√¥ng tin user m·ªôt l·∫ßn duy nh·∫•t
    useEffect(() => {
        if (user && !isInitialized) {
            if (user?.name) {
                setCustomerName(user.name);
            }
            if (user?.address) {
                setShippingAddress(user.address);
            }
            if (user?.phone) {
                setPhoneNumber(user.phone);
            }
            setIsInitialized(true);
        }
    }, [user, isInitialized]);

    // Validate s·ªë ƒëi·ªán tho·∫°i
    const validatePhoneNumber = (phone) => {
        // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
        const cleanPhone = phone.replace(/\D/g, '');

        // Ki·ªÉm tra ƒë·ªô d√†i
        if (cleanPhone.length === 0) {
            return { isValid: false, message: 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i' };
        }

        if (cleanPhone.length < 10) {
            return { isValid: false, message: 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ √≠t nh·∫•t 10 s·ªë' };
        }

        if (cleanPhone.length > 10) {
            return { isValid: false, message: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c qu√° 10 s·ªë' };
        }

        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam (b·∫Øt ƒë·∫ßu b·∫±ng 0)
        if (!cleanPhone.startsWith('0')) {
            return { isValid: false, message: 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0' };
        }

        return { isValid: true, message: '' };
    };

    // Handle phone number change
    const handlePhoneNumberChange = (e) => {
        const value = e.target.value;

        // Ch·ªâ cho ph√©p nh·∫≠p s·ªë
        const numericValue = value.replace(/\D/g, '');

        setPhoneNumber(numericValue);

        // Validate v√† hi·ªÉn th·ªã l·ªói
        const validation = validatePhoneNumber(numericValue);
        setPhoneError(validation.message);
    };

    // T√≠nh t·ªïng gi√°
    const calculateTotalPrice = () => {
        if (isFromCart && cartItems.length > 0) {
            // T√≠nh t·ªïng cho gi·ªè h√†ng
            const subtotal = cartItems.reduce((total, item) => {
                const itemPrice = item.product.price * item.quantity;
                const discountAmount = item.product.discountPercentage > 0
                    ? itemPrice * item.product.discountPercentage / 100
                    : 0;
                return total + (itemPrice - discountAmount);
            }, 0);
            return subtotal;
        } else if (productDetails) {
            // T√≠nh t·ªïng cho s·∫£n ph·∫©m ƒë∆°n l·∫ª
            const subtotal = productDetails.price * quantity;
            const discountAmount = productDetails.discountPercentage > 0
                ? subtotal * productDetails.discountPercentage / 100
                : 0;
            return subtotal - discountAmount;
        }
        return 0;
    };

    // X·ª≠ l√Ω l·ªói thanh to√°n MoMo
    const handleMoMoPaymentError = (error) => {
        setPaymentError(error);
        setIsProcessingPayment(false);
    };

    // X·ª≠ l√Ω ƒë·∫∑t h√†ng COD
    const handleCreateOrder = async () => {
        // Ki·ªÉm tra t√™n ng∆∞·ªùi ƒë·∫∑t
        if (!customerName.trim()) {
            alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ƒë·∫∑t');
            return;
        }

        // Ki·ªÉm tra ƒë·ªãa ch·ªâ
        if (!shippingAddress.trim()) {
            alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng');
            return;
        }

        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i
        const phoneValidation = validatePhoneNumber(phoneNumber);
        if (!phoneValidation.isValid) {
            setPhoneError(phoneValidation.message);
            return;
        }

        // N·∫øu l√† thanh to√°n MoMo, kh√¥ng x·ª≠ l√Ω ·ªü ƒë√¢y
        if (paymentMethod === 'MOMO') {
            return;
        }

        setIsProcessingPayment(true);
        setPaymentError('');

        try {
            const totalPrice = calculateTotalPrice();

            let orderData;
            if (isFromCart && cartItems.length > 0) {
                // T·∫°o ƒë∆°n h√†ng t·ª´ gi·ªè h√†ng
                orderData = {
                    items: cartItems.map(item => ({
                        product: item.product._id,
                        quantity: item.quantity,
                        price: item.product.price
                    })),
                    totalPrice,
                    customerName,
                    shippingAddress,
                    phoneNumber,
                    paymentMethod: paymentMethod,
                    codDetails: {
                        phoneNumberConfirmed: false,
                        additionalNotes: `Thanh to√°n cho ${cartItems.length} s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng`
                    }
                };
            } else {
                // T·∫°o ƒë∆°n h√†ng t·ª´ s·∫£n ph·∫©m ƒë∆°n l·∫ª
                orderData = {
                    items: [{
                        product: productDetails._id,
                        quantity: quantity,
                        price: productDetails.price
                    }],
                    totalPrice,
                    customerName,
                    shippingAddress,
                    phoneNumber,
                    paymentMethod: paymentMethod,
                    codDetails: {
                        phoneNumberConfirmed: false,
                        additionalNotes: `Thanh to√°n cho s·∫£n ph·∫©m: ${productDetails.name}`
                    }
                };
            }

            const result = await dispatch(createOrder(orderData)).unwrap();

            alert('ƒê·∫∑t h√†ng th√†nh c√¥ng!');
            navigate('/orders');
        } catch (error) {
            console.error('Order Creation Error:', error);

            // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
            if (error?.code === 'NO_AUTH_USER') {
                alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                navigate('/login');
            } else if (error?.code === 'NO_ITEMS') {
                alert('Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ ƒë·∫∑t h√†ng.');
            } else if (error?.code === 'NO_ADDRESS') {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.');
            } else {
                setPaymentError(error?.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } finally {
            setIsProcessingPayment(false);
        }
    };

    // N·∫øu kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m, kh√¥ng render g√¨ c·∫£
    if (!productDetails && (!cartItems || cartItems.length === 0)) {
        return null;
    }

    return (
        <div className="max-w-4xl mx-auto p-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8 text-center">Thanh To√°n</h1>

            <div className="grid lg:grid-cols-2 gap-8">
                {/* Left Column - Product Details */}
                <Card className="h-fit">
                    <div className="p-6">
                        <h2 className="text-xl font-bold mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h2>

                        {/* Product Items */}
                        {isFromCart && cartItems.length > 0 ? (
                            // Hi·ªÉn th·ªã nhi·ªÅu s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng
                            <div className="space-y-3 mb-4">
                                {cartItems.map((item, index) => (
                                    <div key={index} className="flex items-center space-x-4 p-4 border rounded-lg">
                                        <div className="relative">
                                            <img
                                                src={item.product.images?.[0] || "https://via.placeholder.com/80x80?text=No+Image"}
                                                alt={item.product.name}
                                                className="w-20 h-20 object-cover rounded"
                                            />
                                            <div className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                                                {item.quantity}
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-800">{item.product.name}</h3>
                                            <p className="text-sm text-gray-500">Size: {item.product.size || 'Standard'}</p>
                                            <p className="text-sm text-gray-500">Color: {item.product.color || 'Default'}</p>
                                            <p className="font-bold text-lg">{item.product.price?.toLocaleString()}‚Ç´</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            // Hi·ªÉn th·ªã s·∫£n ph·∫©m ƒë∆°n l·∫ª
                            <div className="flex items-center space-x-4 p-4 border rounded-lg mb-4">
                                <div className="relative">
                                    <img
                                        src={productDetails.images?.[0] || "https://via.placeholder.com/80x80?text=No+Image"}
                                        alt={productDetails.name}
                                        className="w-20 h-20 object-cover rounded"
                                    />
                                    <div className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                                        {quantity}
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-semibold text-gray-800">{productDetails.name}</h3>
                                    <p className="text-sm text-gray-500">Size: {productDetails.size || 'Standard'}</p>
                                    <p className="text-sm text-gray-500">Color: {productDetails.color || 'Default'}</p>
                                    <p className="font-bold text-lg">{productDetails.price?.toLocaleString()}‚Ç´</p>
                                </div>
                            </div>
                        )}

                        {/* Order Summary */}
                        <div className="border-t pt-4">
                            <h3 className="font-semibold mb-3">Order Summary</h3>
                            <div className="space-y-2">
                                {isFromCart && cartItems.length > 0 ? (
                                    // Hi·ªÉn th·ªã summary cho gi·ªè h√†ng
                                    <>
                                        {cartItems.map((item, index) => (
                                            <div key={index} className="flex justify-between">
                                                <span>{item.product.name} x{item.quantity}</span>
                                                <span>{(item.product.price * item.quantity).toLocaleString()}‚Ç´</span>
                                            </div>
                                        ))}
                                        {cartItems.some(item => item.product.discountPercentage > 0) && (
                                            <div className="flex justify-between text-red-600">
                                                <span>Discount</span>
                                                <span>-{cartItems.reduce((total, item) => {
                                                    const discount = item.product.discountPercentage > 0
                                                        ? item.product.price * item.quantity * item.product.discountPercentage / 100
                                                        : 0;
                                                    return total + discount;
                                                }, 0).toLocaleString()}‚Ç´</span>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    // Hi·ªÉn th·ªã summary cho s·∫£n ph·∫©m ƒë∆°n l·∫ª
                                    <>
                                        <div className="flex justify-between">
                                            <span>Subtotal</span>
                                            <span>{(productDetails.price * quantity).toLocaleString()}‚Ç´</span>
                                        </div>
                                        {productDetails.discountPercentage > 0 && (
                                            <div className="flex justify-between text-red-600">
                                                <span>Discount (-{productDetails.discountPercentage}%)</span>
                                                <span>-{Math.round(productDetails.price * quantity * productDetails.discountPercentage / 100).toLocaleString()}‚Ç´</span>
                                            </div>
                                        )}
                                    </>
                                )}
                                <div className="flex justify-between font-bold text-lg">
                                    <span>Total</span>
                                    <span>{calculateTotalPrice()?.toLocaleString()}‚Ç´</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Card>

                {/* Right Column - Checkout Form */}
                <Card>
                    <div className="p-6">
                        <h2 className="text-xl font-bold mb-4">Th√¥ng tin giao h√†ng</h2>

                        {/* T√™n ng∆∞·ªùi ƒë·∫∑t */}
                        <div className="mb-4">
                            <label className="block mb-2 font-medium">T√™n Ng∆∞·ªùi ƒê·∫∑t</label>
                            <input
                                type="text"
                                value={customerName}
                                onChange={(e) => {
                                    console.log('Customer name changed:', e.target.value);
                                    setCustomerName(e.target.value);
                                }}
                                placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ƒë·∫∑t"
                                required
                                className="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* ƒê·ªãa ch·ªâ giao h√†ng */}
                        <div className="mb-4">
                            <label className="block mb-2 font-medium">ƒê·ªãa Ch·ªâ Giao H√†ng</label>
                            <input
                                type="text"
                                value={shippingAddress}
                                onChange={(e) => {
                                    console.log('Shipping address changed:', e.target.value);
                                    setShippingAddress(e.target.value);
                                }}
                                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng"
                                required
                                className="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* S·ªë ƒëi·ªán tho·∫°i */}
                        <div className="mb-4">
                            <label className="block mb-2 font-medium">S·ªë ƒêi·ªán Tho·∫°i</label>
                            <input
                                type="tel"
                                value={phoneNumber}
                                onChange={handlePhoneNumberChange}
                                placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (VD: 0123456789)"
                                required
                                className={`flex h-9 w-full rounded-md border px-3 py-1 text-sm shadow-sm transition-colors focus:outline-none focus:ring-2 ${phoneError
                                        ? "border-red-500 focus:ring-red-500 focus:border-red-500"
                                        : "border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                    }`}
                            />
                            {phoneError && <p className="mt-1 text-sm text-red-600">{phoneError}</p>}
                        </div>

                        {/* Ph∆∞∆°ng th·ª©c thanh to√°n */}
                        <div className="mb-6">
                            <PaymentMethod
                                selectedMethod={paymentMethod}
                                onMethodChange={setPaymentMethod}
                                disabled={isProcessingPayment}
                            />
                        </div>

                        {/* Hi·ªÉn th·ªã l·ªói thanh to√°n */}
                        {paymentError && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700">
                                {paymentError}
                            </div>
                        )}

                        {/* Form thanh to√°n MoMo */}
                        {paymentMethod === 'MOMO' && (
                            <div className="mb-6">
                                <MoMoPaymentForm
                                    amount={calculateTotalPrice()}
                                    orderInfo={isFromCart && cartItems.length > 0
                                        ? `Thanh to√°n cho ${cartItems.length} s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng`
                                        : `Thanh to√°n cho s·∫£n ph·∫©m: ${productDetails.name}`
                                    }
                                    onError={handleMoMoPaymentError}
                                    disabled={isProcessingPayment || !customerName.trim() || !shippingAddress.trim() || !phoneNumber.trim() || phoneError}
                                    productDetails={productDetails}
                                    cartItems={cartItems}
                                    isFromCart={isFromCart}
                                    quantity={quantity}
                                    customerName={customerName}
                                    shippingAddress={shippingAddress}
                                    phoneNumber={phoneNumber}
                                />
                            </div>
                        )}

                        {/* N√∫t ƒë·∫∑t h√†ng cho COD */}
                        {paymentMethod !== 'MOMO' && (
                            <Button
                                onClick={handleCreateOrder}
                                disabled={isProcessingPayment}
                                className="w-full bg-black text-white hover:bg-gray-800 py-3"
                            >
                                {isProcessingPayment ? (
                                    <div className="flex items-center space-x-2">
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>ƒêang x·ª≠ l√Ω...</span>
                                    </div>
                                ) : (
                                    'ƒê·∫∑t h√†ng ‚Üí'
                                )}
                            </Button>
                        )}
                    </div>
                </Card>
            </div>
        </div>
    );
};

export default CheckoutPage;